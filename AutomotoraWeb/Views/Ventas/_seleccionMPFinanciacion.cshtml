@model DLL_Backend.Venta
@using AutomotoraWeb.Helpers;
@using DLL_Backend;
@using AutomotoraWeb.Models;

<div id="contenedorSeleccionMPFinanciacion">
    <div>
        <div class="display-label">
            Financiado
        </div>
        <div class="editor-field editor-field-small">
            @Html.DdlOrDisplayImporteFor(model => model.Financiacion.MontoFinanciado, false)
            @Html.ValidationMessageFor(model => model.Financiacion.MontoFinanciado.Monto)
        </div>
        <div class="clear-both"></div>

        <div class="display-label">
            @Html.LabelForRequired(model => model.Financiacion.CantCuotas)
        </div>
        <div class="editor-field editor-field-small">
            @Html.EditorOrDisplayFor(model => model.Financiacion.CantCuotas, false, new { id = "inputFinanciacionCuotaCantCuotas" })
            @Html.ValidationMessageFor(model => model.Financiacion.CantCuotas)
        </div>
        <div class="clear-both"></div>

        <div class="display-label">
            @Html.LabelForRequired(model => model.Financiacion.Tasa)
        </div>
        <div class="editor-field editor-field-small">
            @Html.EditorOrDisplayFor(model => model.Financiacion.Tasa, false, new { id = "inputFinanciacionCuotaTasa" })
            @Html.ValidationMessageFor(model => model.Financiacion.Tasa)
        </div>
        <div class="clear-both"></div>

        <div class="btn-group">
            @if (true){
                @(Html.Bootstrap().Button().Text("Cambiar Financiación").Id("cambiarFinanciacion").AppendIcon(TwitterBootstrapMVC.Icons.plus, true).Style(TwitterBootstrap2.ButtonStyle.Primary))
            }
        )
        </div>
        <div id="messageErrorCambiarFinanciacion" style="margin-left: 15px; color: red;"></div>
    </div>

    <div>
        @Html.Partial("_grillaPagosCuota", (List<Cuota>)(ViewBag.Cuotas))
    </div>

    <script type="text/javascript">

        function OnBeginCallback(s, e) {
            e.customArgs["idSession"] = '@ViewData["idSession"]';
            e.customArgs["idParametros"] = '@ViewData["idParametros"]';
        }

        $("#cambiarFinanciacion").click(function () {

            if (_validateImporteCambiarFinanciacion()) {

                $("#messageErrorCambiarFinanciacion").html("");

                var urlAction = '@(Url.Action("cambiarFinanciacion", "ventas"))'

                $.ajax({
                    url: urlAction,
                    type: 'POST',
                    async: true,
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    data: getJsonPagoFinanciacion(),
                    success: function (data) {
                        if (data.Result == "OK") {
                            grillaPagosCuota.Refresh(); // Se actualiza la grilla
                        }
                        else {
                            $("#" + containerErrorMessage).html("ERROR");
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        general_showErrorAction(containerErrorMessage, textStatus, errorThrown);
                    }
                });
            }
            else {
                $("#messageErrorCambiarFinanciacion").html("El monto debe de ser un valor numérico");
            }

        });

        function _validateImporteCambiarFinanciacion() {
            var monto = $("#txMontoFinanciadoMonto").val()

            var isDecimal_re = /^\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*$/;
            return String(monto).search(isDecimal_re) != -1
        }

        function getJsonPagoFinanciacion() {

            var idSession = '@(ViewData["idSession"])';

            var pagoFinanciacion = {
                cantCuotas :$("#inputFinanciacionCuotaCantCuotas").val(),
                tasa : $("#inputFinanciacionCuotaTasa").val(), 
                importe: {
                    Moneda: {
                        Codigo: $("#ddlMontoFinanciadoMoneda").val()
                    },
                    Monto: $("#txMontoFinanciadoMonto").val()
                },
                idSession: idSession
            };

            return JSON.stringify(pagoFinanciacion);
        }

    </script>
</div>
